<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>

<head>
  <title>DataVision User's Manual</title>
  <link rel='stylesheet' href='style.css' type='text/css'>

</head>

<body>

<table width='100%'>
<tr><td><a href="rundv.html">&lt;= Previous</a> | <a href="create.html">Next =&gt;</a> | <a href="DataVision.html">Table of Contents</a></td><td align='right'>
  <span class='header'>DataVision User's Manual</span>
</td></tr>
</table>
<hr>
<!-- **************************************************************** -->

<h1>4 Incorporating DataVision Into a Java Application</h1>
<p>
It isn't difficult to incorporate DataVision into a Java application.
Instantiate a Report object and have it read the XML file and possibly a
parameter value XML file, then give the report object a layout engine
object (such as LaTeXLE).
</p>

<p>
To run a report from a JSP page, see <a href="#jsp"><span class="sec">Running DataVision
from JSP</span></a> below.
</p>

<p>
To run your application you will need to include in your classpath the
JAR files that are in the <span class="dir">lib</span> directory. They include
</p>

<ul>
  <li>DataVision,</li>
  <li>iText, the Java-PDF library by Bruno Lowagie,</li>
  <li>JCalendar, the calendar Swing widget by Kai Toedter,</li>
  <li>BSF, the Bean Scripting Framework from the Apache Jakarta Project,</li>
  <li>JRuby, the Java implementation of Ruby by the JRuby Project, and</li>
</ul>

<p>
Here is the code you need to run a report from within your application.
First, we will present some code chunks interspersed with insightful
commentary. A few complete examples, showing different data sources and
layout engines, will round out this section.
</p>




<p>
<span class="codeblock-title">Creating a report object</span>
</p>

<p>
First, create a report object.
</p>

<pre class="codeblock">
Report report = new Report();
</pre>




<p>
<span class="codeblock-title">Specifying a database data source</span>
</p>

<p>
What happens next depends upon the data source that the report XML file
describes. If it's a database, we have to give some information (the
database password) to the report before we read the XML file. If the data
source is a text file, we need to specify some things after the XML file is
read and the data source object is created.
</p>

<p>
The report's connection to a database can be specified one of three
ways. You can supply a database password, a
<span class="class">java.sql.Connection</span> object, or a
<span class="class">jimm.datavision.sql.Database</span> object.
</p>

<p>
If you supply a password, the XML file's database connection information
will be used to create a new connection. This is what normally happens when
you open a report via the GUI, for example.
</p>

<p>
Both of the other methods (supplying a connection or database object)
ignore the database connection information in the report XML file. If you
supply a connection it will <em>not</em> be closed by the report, even if
the report's database connection is reset by calling
<span class="func">Database.reset</span>. You will have to close the connection yourself
after the report is done running.
</p>

<p>
The only reason you would supply a
<span class="class">jimm.datavision.sql.Database</span> object is to reuse one between
different report instances. The advantage of reusing a database object is
that the database metadata (table names, column names, and more) will only
be read once no matter how many reports use it. Reading the metadata is
time-consuming.
</p>

<pre class="codeblock">
<span class="comment">// Give the report enough information to connect to a database
// data source. Pick one of the following three lines.</span>
report.setDatabasePassword(<span class="string">&quot;mypassword&quot;</span>);
<span class="comment">// or</span>
report.setDatabaseConnection(aJdbcConnection);
<span class="comment">// or</span>
report.setDataSource(new Database(...));
</pre>



<p>
<span class="codeblock-title">Reading the report description XML
file</span>
</p>

<p>
Next, call <span class="func">Report.read</span> to read a report's
description XML. This method can take as an argument a file or an <span
class="class">org.xml.sax.InputSource</span>. The <span
class="class">InputSource</span> constructor can take a <span
class="class">java.io.InputStream</span>, a <span
class="class">java.io.Reader</span>, or a <span class="class">String</span>
that specifies a system identifier. If the system identifier is a URI (a URL),
it must be fully resolved.
</p>

<pre class="codeblock">
<span class="comment">// Read the report XML from a file or various stream types.</span>
report.read(xmlFileOrInputSource); <span class="comment">// Must be after database info</span>
</pre>




<p>
<span class="codeblock-title">Specifying a text file data source</span>
</p>

<p>
If the data source is a text file instead of a database, we need to tell
the data source which file to read and optionally override the separator
character specified in the XML file. If no character is defined in either
the XML file or your code, the default character (comma) is used.
</p>

<p>
The method <span class="func">CharSepSource.setInput</span> can take as an argument a
file name, a <span class="class">java.io.Reader</span>, or a
<span class="class">java.io.InputStreamReader</span>.
</p>

<pre class="codeblock">
CharSepSource src = (CharSepSource)report.getDataSource();
src.setSepChar('\t'); <span class="comment">// Optional; overrides default and XML file value</span>
src.setInput(fileNameOrReaderOrInputStreamReader);
</pre>




<p>
<span class="codeblock-title">Reading parameter values</span>
</p>

<p>
If necessary, read parameter values. There are three ways a report gets
parameter values: by asking the user, by reading a parameter XML file, or
with custom Java code that sets the parameter values. See <a
href="#askparam"><span class="sec">Asking for Parameter Values</span></a> below for a
complete description of the three different ways to set parameter values.
</p>

<p>
The method <span class="func">Report.setParameterXMLInput</span> is used to read parameter
values from XML. This method takes the same arguments as
<span class="func">Report.read</span>, described above.
</p>

<pre class="codeblock">
<span class="comment">// If necessary, read parameter values.</span>
if (report.hasParameterFields())
    report.setParameterXMLInput(paramXMLFileOrInputSource);
</pre>




<p>
<span class="codeblock-title">Setting the layout engine</span>
</p>

<p>
Next, give the report a layout engine. This example uses the LaTeX
layout engine. You could use HTML, PDF, Swing, or any other one.
</p>

<pre class="codeblock">
report.setLayoutEngine(new LaTeXLE(aWriter));
</pre>




<p>
<span class="codeblock-title">Running the report</span>
</p>

<p>
Finally, run the report either in a separate thread or in the current
thread. <span class="func">Report.run</span> runs the report in a separate thread. It
does not wait for the thread to finish. You will have to write the code to
wait. If you call <span class="func">Report.runReport</span>, the report is run
synchronously; the method does not return until the report is done
running.
</p>

<pre class="codeblock">
<span class="comment">// Pick one of the following two.</span>
report.run();         <span class="comment">// Run the report in a separate thread.
// or</span>
report.runReport();   <span class="comment">// Run the report in this thread.</span>
</pre>



<p>
<span class="codeblock-title">Telling a Swing layout engine to
exit</span>
</p>

<p>
If you use a Swing layout engine, there is one more thing you may want
to do: exit. When the user closes the Swing report window, the application
does not automatically quit---the event loop keeps running.
</p>

<p>
The <span class="class">SwingLE</span> layout engine has a method called
<span class="func">close</span>. It does not exit the application, but we can create an
anonymous class that overrides that method and closes the application when
the window is closed. Here's how:
</p>

<pre class="codeblock">
LayoutEngine le = new SwingLE() {
    public void close() {
        super.close();
        System.exit();
    }
};
report.setLayoutEngine(le);
</pre>

<p>
Similarly, when the last design window is closed DataVision normally
exits. The method <span class="func">DesignWin.setExitWhenLastWinClosed</span> does what
it says: it lets you determine if DataVision should exit when the last
design window is closed.
</p>



<p>
<span class="codeblock-title">All together now</span>
</p>

<p>
Here's the whole thing all together. This code will run a report that
uses a database connection to read data, reads the report XML file, reads a
parameter file if necessary, and outputs to a PDF file.
</p>

<pre class="codeblock">
Report report = new Report();
report.setDatabasePassword(<span class="string">&quot;mypassword&quot;</span>);
report.read(<span class="string">&quot;reportXmlFile&quot;</span>);
if (report.hasParameterFields())
    report.setParameterXMLInput(<span class="string">&quot;paramXmlFile&quot;</span>);
OutputStream out = new FileOutputStream(<span class="string">&quot;output.pdf&quot;</span>);
report.setLayoutEngine(new PDFLE(out));
report.runReport();
</pre>

<!-- ================================================================ -->
<a name="askparam">
<h2>4.1 Asking for Parameter Values</h2>
<p>
There are three ways a report gets parameter values: by asking the user, by
reading a parameter XML file, or with custom Java code that sets the
parameter values.
</p>

<!-- ---------------------------------------------------------------- -->
<a name="askuser">
<h3>4.1.1 Asking the User</h3>
<p>
If you want the user to be prompted for input, you should not give the
report a parameter file name. Instead, you should tell the system that you
want to use a Swing window to prompt the user for parameter values by using
the following code some time before running the report:
</p>

<pre class="codeblock">
ErrorHandler.useGUI(true);
</pre>


<!-- ---------------------------------------------------------------- -->
<a name="readparam">
<h3>4.1.2 Reading a Parameter XML File</h3>
<p>
To read a parameter XML file, call <code>Report.setParameterXMLInput</code>.
</p>

<pre class="codeblock">
report.setParameterXMLInput(paramXMLFileOrInputSource);
</pre>

<p>
To specify a parameter file on the command line, use the <b>-r</b> command
line option. See <a href="rundv.html#runcmd"><span class="sec">Running DataVision from
the Command Line</span></a> for details.
</p>


<!-- ---------------------------------------------------------------- -->
<a name="manualparam">
<h3>4.1.3 Setting Values Manually</h3>
<p>
To specify a parameter's value within your code, you need to ask the
report object to find it and then set its value.
</p>

<pre class="codeblock">
<span class="comment">// Ask the report to find the parameter for you</span>
Parameter p = report.findParameter(new Long(myParamID));
<span class="comment">// or p = report.findParameterByName(&quot;My Parameter Name&quot;);</span>

<span class="comment">// Set the parameter's value. This sets a single value.</span>
p.setValue(0, <span class="string">&quot;The New Value&quot;</span>);
<span class="comment">// To set more values (if it is a range or a list of values), keep
// calling setValue().
// p.setValue(1, &quot;Another Value&quot;);</span>
</pre>

<p>
There is one more thing you have to do. As of version 0.7.11, there is a
new method named <code>Report.parametersSetManually</code>. Calling this
method with an argument of <code>true</code> tells the report not to ask
the user and not to read an XML file.
</p>

<pre class="codeblock">
report.parametersSetManually(true);
</pre>

<p>
<span class="note">Calling this method replaces the earlier necessity of creating a
subclass of <code>Report</code> that overrode the
<code>askForParameters</code> method.</span>
</p>



<!-- ================================================================ -->
<a name="jsp">
<h2>4.2 Running DataVision from JSP</h2>
<p>
You can run a report in a JSP page, but you can't display its output
directly, even if you use the HTML layout engine. You need to save the
output to a (possibly temporary) file and then display the contents of that
file or let the user download it.
</p>

<p>
For an example JSP page, see <span class="file">datavision.jsp</span> in the
<span class="dir">examples</span> directory. The comment at the top of that
file contains directions for installing and running it from Tomcat.
</p>

<p>
If your report contains parameters, you will need to let the user enter
them. You then need to give those values to the report before it is run.
Either save the values into a parameter XML file and call
</p>

<pre class="codeblock">
report.setParamterXMLInput("path_to_param_xml_file");
</pre>

<p>
or use the code found in <a href="#askparam"><span class="sec">Asking for Parameter
Values</span></a>.
</p>

<p>
<a href="http://www.omnytex.com/articles/dvweb/"><cite>Reporting For The Web
With DataVision</cite></a>, by Frank W. Zammetti, is an article that shows you
how to design a simple report and run it from within a Web application.</li>



<!-- ================================================================ -->
<a name="applet">
<h2>4.3 Running DataVision as an Applet</h2>
<p>
DataVision can be run as an applet. The file <span class="file">applet.html</span>
contains an example &quot;applet&quot; tag suitable for use with DataVision.
</p>

<p>
<span class="note">The applet code is still under development; expect some
problems.</span>
</p>

<p>
In the example file <span class="file">applet.html</span>, the &quot;archive&quot; attribute
does not contain a database JAR file or <span class="file">jcalendar.jar</span>. To run
reports instead of just design them, you would have to add your JDBC JAR
file and <span class="file">jcalendar.jar</span> to this list. Why aren't those files in
the list already? Because the applet code is being developed first to allow
report design. Running reports should work; I just haven't tested it yet.
</p>

<p>
Since JRuby (and possibly other <a href="anatomy.html#bsf"><span class="sec">Bean Scripting
Framework</span></a> jar files) uses a custom class loader, you will have to
either sign the applet or edit the client's <span class="file">java.policy</span> file and
add the line
</p>

<pre class="codeblock">
permission java.lang.RuntimePermission "getClassLoader";
</pre>

<p>
<span class="note">Many thanks to Edwin Ramirez, who has funded development of
DataVision in order to create the applet code. All of his suggestions and
feature requests have been folded into DataVision.</span>
</p>

<!-- **************************************************************** -->
<hr>
<table width='100%'>
<tr><td><a href="rundv.html">&lt;= Previous</a> | <a href="create.html">Next =&gt;</a> | <a href="DataVision.html">Table of Contents</a></td><td align='center'>
&nbsp;
</td><td align='right'>
    <span class='footer'>DataVision User's Manual</span>
</td></tr>
</table>

</body>
</html>
